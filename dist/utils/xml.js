"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports.parseXml = parseXml;exports.generateXml = generateXml;exports.filterAttributes = filterAttributes;exports.prepareItemsForXml = prepareItemsForXml;exports.prepareItemForXml = prepareItemForXml;var _xml2js = _interopRequireDefault(require("xml2js"));
var _es6Promisify = require("es6-promisify");
var _dataElement = _interopRequireDefault(require("../data-element"));function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { default: obj };}

const parseOptions = {
  attrkey: "attr",
  charkey: "val",
  explicitCharkey: true,
  normalizeTags: true,
  trim: true,
  attrNameProcessors: [name => name.toLowerCase()]

  // TODO: test async: true
};
const buildOptions = {
  attrkey: "attr",
  charkey: "val",
  xmldec: { version: "1.0", encoding: "UTF-8" } };


async function parseXml(
data,
normalizeTagCase = true,
normalizeAttrCase = true)
{
  let result;
  let options = parseOptions;

  if (!normalizeTagCase) {
    delete options.normalizeTags;
  }
  if (!normalizeAttrCase) {
    delete options.attrNameProcessors;
  }

  try {
    result = await (0, _es6Promisify.promisify)(_xml2js.default.parseString)(data, parseOptions);
    return result;
  } catch (err) {
    console.warn("Error parsing xml:", err);
    return;
  }
}

async function generateXml(data, isFragment = false) {
  if (isFragment) {
    const options = Object.assign(buildOptions, {
      headless: true });

  }
  const builder = new _xml2js.default.Builder(buildOptions);
  const xml = builder.buildObject(data);
  return xml;
}

function filterAttributes(attributes) {
  if (Object.keys(attributes).length) {
    const attr = Object.entries(attributes).
    filter(([key, value]) => {
      return value !== undefined;
    }).
    reduce((obj, [key, value]) => {
      obj[key] = attributes[key];
      return obj;
    }, {});

    if (Object.keys(attr).length) {
      return attr;
    }
  }
  return undefined;
}

function prepareItemsForXml(items) {
  const dataList = {};
  items.forEach(item => {
    // const data = {};
    // if (item.attributes) {
    //   const attr = filterAttributes(item.attributes);
    //   if (attr) {
    //     data.attr = attr;
    //   }
    // }
    // if (item.value) {
    //   data.val = item.value;
    // }
    // if (Array.isArray(dataList[item.element])) {
    //   dataList[item.element].push(data);
    // } else {
    //   dataList[item.element] = [data];
    // }

    const preparedItem = prepareItemForXml(item);

    if (Array.isArray(dataList[item.element])) {
      dataList[item.element].push(preparedItem);
    } else {
      dataList[item.element] = [preparedItem];
    }
  });
  return dataList;
}

function prepareItemForXml(item) {
  let data = {};

  const entries = Object.entries(item);

  for (let [key, value] of Object.entries(item)) {
    //if (item.hasOwnProperty(key)) {
    if (key === "_attributes") {
      const attr = filterAttributes(value);
      if (attr) {
        data.attr = attr;
      }
    } else if (key === "value" && value) {
      data.val = value;
    } else if (value instanceof _dataElement.default) {
      // this is a child dataelement
      // TODO: handle recursion...
      //const child = value;

      data[value.element] = prepareItemForXml(value);
    } else if (Array.isArray(value) && value.length > 0) {
      const children = prepareItemsForXml(value);
      Object.assign(data, children);
    }
    //}
  }
  // if (item.attributes) {
  //   const attr = filterAttributes(item.attributes);
  //   if (attr) {
  //     data.attr = attr;
  //   }
  // }
  // if (item.value) {
  //   data.val = item.value;
  // }

  return data;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy91dGlscy94bWwuanMiXSwibmFtZXMiOlsicGFyc2VPcHRpb25zIiwiYXR0cmtleSIsImNoYXJrZXkiLCJleHBsaWNpdENoYXJrZXkiLCJub3JtYWxpemVUYWdzIiwidHJpbSIsImF0dHJOYW1lUHJvY2Vzc29ycyIsIm5hbWUiLCJ0b0xvd2VyQ2FzZSIsImJ1aWxkT3B0aW9ucyIsInhtbGRlYyIsInZlcnNpb24iLCJlbmNvZGluZyIsInBhcnNlWG1sIiwiZGF0YSIsIm5vcm1hbGl6ZVRhZ0Nhc2UiLCJub3JtYWxpemVBdHRyQ2FzZSIsInJlc3VsdCIsIm9wdGlvbnMiLCJ4bWwyanMiLCJwYXJzZVN0cmluZyIsImVyciIsImNvbnNvbGUiLCJ3YXJuIiwiZ2VuZXJhdGVYbWwiLCJpc0ZyYWdtZW50IiwiT2JqZWN0IiwiYXNzaWduIiwiaGVhZGxlc3MiLCJidWlsZGVyIiwiQnVpbGRlciIsInhtbCIsImJ1aWxkT2JqZWN0IiwiZmlsdGVyQXR0cmlidXRlcyIsImF0dHJpYnV0ZXMiLCJrZXlzIiwibGVuZ3RoIiwiYXR0ciIsImVudHJpZXMiLCJmaWx0ZXIiLCJrZXkiLCJ2YWx1ZSIsInVuZGVmaW5lZCIsInJlZHVjZSIsIm9iaiIsInByZXBhcmVJdGVtc0ZvclhtbCIsIml0ZW1zIiwiZGF0YUxpc3QiLCJmb3JFYWNoIiwiaXRlbSIsInByZXBhcmVkSXRlbSIsInByZXBhcmVJdGVtRm9yWG1sIiwiQXJyYXkiLCJpc0FycmF5IiwiZWxlbWVudCIsInB1c2giLCJ2YWwiLCJEYXRhRWxlbWVudCIsImNoaWxkcmVuIl0sIm1hcHBpbmdzIjoibVJBQUE7QUFDQTtBQUNBLHNFOztBQUVBLE1BQU1BLFlBQVksR0FBRztBQUNuQkMsRUFBQUEsT0FBTyxFQUFFLE1BRFU7QUFFbkJDLEVBQUFBLE9BQU8sRUFBRSxLQUZVO0FBR25CQyxFQUFBQSxlQUFlLEVBQUUsSUFIRTtBQUluQkMsRUFBQUEsYUFBYSxFQUFFLElBSkk7QUFLbkJDLEVBQUFBLElBQUksRUFB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QSxLQUFLLENBQUNMLE1BQU4sR0FBZSxDQUEzQyxFQUE4QztBQUNuRCxZQUFNc0IsUUFBUSxHQUFHYixrQkFBa0IsQ0FBQ0osS0FBRCxDQUFuQztBQUNBZixNQUFBQSxNQUFNLENBQUNDLE1BQVAsQ0FBY2IsSUFBZCxFQUFvQjRDLFFBQXBCO0FBQ0Q7QUFDRDtBQUNEO0FBQ0Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBOztBQUVBLFNBQU81QyxJQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeG1sMmpzIGZyb20gXCJ4bWwyanNcIjtcbmltcG9ydCB7IHByb21pc2lmeSB9IGZyb20gXCJlczYtcHJvbWlzaWZ5XCI7XG5pbXBvcnQgRGF0YUVsZW1lbnQgZnJvbSBcIi4uL2RhdGEtZWxlbWVudFwiO1xuXG5jb25zdCBwYXJzZU9wdGlvbnMgPSB7XG4gIGF0dHJrZXk6IFwiYXR0clwiLFxuICBjaGFya2V5OiBcInZhbFwiLFxuICBleHBsaWNpdENoYXJrZXk6IHRydWUsXG4gIG5vcm1hbGl6ZVRhZ3M6IHRydWUsXG4gIHRyaW06IHRydWUsXG4gIGF0dHJOYW1lUHJvY2Vzc29yczogWyhuYW1lKSA9PiBuYW1lLnRvTG93ZXJDYXNlKCldLFxuXG4gIC8vIFRPRE86IHRlc3QgYXN5bmM6IHRydWVcbn07XG5jb25zdCBidWlsZE9wdGlvbnMgPSB7XG4gIGF0dHJrZXk6IFwiYXR0clwiLFxuICBjaGFya2V5OiBcInZhbFwiLFxuICB4bWxkZWM6IHsgdmVyc2lvbjogXCIxLjBcIiwgZW5jb2Rpbmc6IFwiVVRGLThcIiB9LFxufTtcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHBhcnNlWG1sKFxuICBkYXRhLFxuICBub3JtYWxpemVUYWdDYXNlID0gdHJ1ZSxcbiAgbm9ybWFsaXplQXR0ckNhc2UgPSB0cnVlXG4pIHtcbiAgbGV0IHJlc3VsdDtcbiAgbGV0IG9wdGlvbnMgPSBwYXJzZU9wdGlvbnM7XG5cbiAgaWYgKCFub3JtYWxpemVUYWdDYXNlKSB7XG4gICAgZGVsZXRlIG9wdGlvbnMubm9ybWFsaXplVGFncztcbiAgfVxuICBpZiAoIW5vcm1hbGl6ZUF0dHJDYXNlKSB7XG4gICAgZGVsZXRlIG9wdGlvbnMuYXR0ck5hbWVQcm9jZXNzb3JzO1xuICB9XG5cbiAgdHJ5IHtcbiAgICByZXN1bHQgPSBhd2FpdCBwcm9taXNpZnkoeG1sMmpzLnBhcnNlU3RyaW5nKShkYXRhLCBwYXJzZU9wdGlvbnMpO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGNvbnNvbGUud2FybihcIkVycm9yIHBhcnNpbmcgeG1sOlwiLCBlcnIpO1xuICAgIHJldHVybjtcbiAgfVxufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVYbWwoZGF0YSwgaXNGcmFnbWVudCA9IGZhbHNlKSB7XG4gIGlmIChpc0ZyYWdtZW50KSB7XG4gICAgY29uc3Qgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oYnVpbGRPcHRpb25zLCB7XG4gICAgICBoZWFkbGVzczogdHJ1ZSxcbiAgICB9KTtcbiAgfVxuICBjb25zdCBidWlsZGVyID0gbmV3IHhtbDJqcy5CdWlsZGVyKGJ1aWxkT3B0aW9ucyk7XG4gIGNvbnN0IHhtbCA9IGJ1aWxkZXIuYnVpbGRPYmplY3QoZGF0YSk7XG4gIHJldHVybiB4bWw7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBmaWx0ZXJBdHRyaWJ1dGVzKGF0dHJpYnV0ZXMpIHtcbiAgaWYgKE9iamVjdC5rZXlzKGF0dHJpYnV0ZXMpLmxlbmd0aCkge1xuICAgIGNvbnN0IGF0dHIgPSBPYmplY3QuZW50cmllcyhhdHRyaWJ1dGVzKVxuICAgICAgLmZpbHRlcigoW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgIHJldHVybiB2YWx1ZSAhPT0gdW5kZWZpbmVkO1xuICAgICAgfSlcbiAgICAgIC5yZWR1Y2UoKG9iaiwgW2tleSwgdmFsdWVdKSA9PiB7XG4gICAgICAgIG9ialtrZXldID0gYXR0cmlidXRlc1trZXldO1xuICAgICAgICByZXR1cm4gb2JqO1xuICAgICAgfSwge30pO1xuXG4gICAgaWYgKE9iamVjdC5rZXlzKGF0dHIpLmxlbmd0aCkge1xuICAgICAgcmV0dXJuIGF0dHI7XG4gICAgfVxuICB9XG4gIHJldHVybiB1bmRlZmluZWQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmVwYXJlSXRlbXNGb3JYbWwoaXRlbXMpIHtcbiAgY29uc3QgZGF0YUxpc3QgPSB7fTtcbiAgaXRlbXMuZm9yRWFjaCgoaXRlbSkgPT4ge1xuICAgIC8vIGNvbnN0IGRhdGEgPSB7fTtcbiAgICAvLyBpZiAoaXRlbS5hdHRyaWJ1dGVzKSB7XG4gICAgLy8gICBjb25zdCBhdHRyID0gZmlsdGVyQXR0cmlidXRlcyhpdGVtLmF0dHJpYnV0ZXMpO1xuICAgIC8vICAgaWYgKGF0dHIpIHtcbiAgICAvLyAgICAgZGF0YS5hdHRyID0gYXR0cjtcbiAgICAvLyAgIH1cbiAgICAvLyB9XG4gICAgLy8gaWYgKGl0ZW0udmFsdWUpIHtcbiAgICAvLyAgIGRhdGEudmFsID0gaXRlbS52YWx1ZTtcbiAgICAvLyB9XG4gICAgLy8gaWYgKEFycmF5LmlzQXJyYXkoZGF0YUxpc3RbaXRlbS5lbGVtZW50XSkpIHtcbiAgICAvLyAgIGRhdGFMaXN0W2l0ZW0uZWxlbWVudF0ucHVzaChkYXRhKTtcbiAgICAvLyB9IGVsc2Uge1xuICAgIC8vICAgZGF0YUxpc3RbaXRlbS5lbGVtZW50XSA9IFtkYXRhXTtcbiAgICAvLyB9XG5cbiAgICBjb25zdCBwcmVwYXJlZEl0ZW0gPSBwcmVwYXJlSXRlbUZvclhtbChpdGVtKTtcblxuICAgIGlmIChBcnJheS5pc0FycmF5KGRhdGFMaXN0W2l0ZW0uZWxlbWVudF0pKSB7XG4gICAgICBkYXRhTGlzdFtpdGVtLmVsZW1lbnRdLnB1c2gocHJlcGFyZWRJdGVtKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZGF0YUxpc3RbaXRlbS5lbGVtZW50XSA9IFtwcmVwYXJlZEl0ZW1dO1xuICAgIH1cbiAgfSk7XG4gIHJldHVybiBkYXRhTGlzdDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHByZXBhcmVJdGVtRm9yWG1sKGl0ZW0pIHtcbiAgbGV0IGRhdGEgPSB7fTtcblxuICBjb25zdCBlbnRyaWVzID0gT2JqZWN0LmVudHJpZXMoaXRlbSk7XG5cbiAgZm9yIChsZXQgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGl0ZW0pKSB7XG4gICAgLy9pZiAoaXRlbS5oYXNPd25Qcm9wZXJ0eShrZXkpKSB7XG4gICAgaWYgKGtleSA9PT0gXCJfYXR0cmlidXRlc1wiKSB7XG4gICAgICBjb25zdCBhdHRyID0gZmlsdGVyQXR0cmlidXRlcyh2YWx1ZSk7XG4gICAgICBpZiAoYXR0cikge1xuICAgICAgICBkYXRhLmF0dHIgPSBhdHRyO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoa2V5ID09PSBcInZhbHVlXCIgJiYgdmFsdWUpIHtcbiAgICAgIGRhdGEudmFsID0gdmFsdWU7XG4gICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGFFbGVtZW50KSB7XG4gICAgICAvLyB0aGlzIGlzIGEgY2hpbGQgZGF0YWVsZW1lbnRcbiAgICAgIC8vIFRPRE86IGhhbmRsZSByZWN1cnNpb24uLi5cbiAgICAgIC8vY29uc3QgY2hpbGQgPSB2YWx1ZTtcblxuICAgICAgZGF0YVt2YWx1ZS5lbGVtZW50XSA9IHByZXBhcmVJdGVtRm9yWG1sKHZhbHVlKTtcbiAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkodmFsdWUpICYmIHZhbHVlLmxlbmd0aCA+IDApIHtcbiAgICAgIGNvbnN0IGNoaWxkcmVuID0gcHJlcGFyZUl0ZW1zRm9yWG1sKHZhbHVlKTtcbiAgICAgIE9iamVjdC5hc3NpZ24oZGF0YSwgY2hpbGRyZW4pO1xuICAgIH1cbiAgICAvL31cbiAgfVxuICAvLyBpZiAoaXRlbS5hdHRyaWJ1dGVzKSB7XG4gIC8vICAgY29uc3QgYXR0ciA9IGZpbHRlckF0dHJpYnV0ZXMoaXRlbS5hdHRyaWJ1dGVzKTtcbiAgLy8gICBpZiAoYXR0cikge1xuICAvLyAgICAgZGF0YS5hdHRyID0gYXR0cjtcbiAgLy8gICB9XG4gIC8vIH1cbiAgLy8gaWYgKGl0ZW0udmFsdWUpIHtcbiAgLy8gICBkYXRhLnZhbCA9IGl0ZW0udmFsdWU7XG4gIC8vIH1cblxuICByZXR1cm4gZGF0YTtcbn1cbiJdfQ==