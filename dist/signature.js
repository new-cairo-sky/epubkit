"use strict";Object.defineProperty(exports, "__esModule", { value: true });exports["default"] = void 0;var _path = _interopRequireDefault(require("path"));
var xmldsigjs = _interopRequireWildcard(require("xmldsigjs"));

var _dataElement = _interopRequireDefault(require("./data-element"));
var _fileManager = _interopRequireDefault(require("./file-manager"));
var _signatureManifest = _interopRequireDefault(require("./signature-manifest"));
var _signatureSignedInfo = _interopRequireDefault(require("./signature-signed-info"));
var _signatureValue = _interopRequireDefault(require("./signature-value"));
var _xml = require("./utils/xml");function _getRequireWildcardCache() {if (typeof WeakMap !== "function") return null;var cache = new WeakMap();_getRequireWildcardCache = function _getRequireWildcardCache() {return cache;};return cache;}function _interopRequireWildcard(obj) {if (obj && obj.__esModule) {return obj;}if (obj === null || _typeof(obj) !== "object" && typeof obj !== "function") {return { "default": obj };}var cache = _getRequireWildcardCache();if (cache && cache.has(obj)) {return cache.get(obj);}var newObj = {};var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;for (var key in obj) {if (Object.prototype.hasOwnProperty.call(obj, key)) {var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;if (desc && (desc.get || desc.set)) {Object.defineProperty(newObj, key, desc);} else {newObj[key] = obj[key];}}}newObj["default"] = obj;if (cache) {cache.set(obj, newObj);}return newObj;}function _interopRequireDefault(obj) {return obj && obj.__esModule ? obj : { "default": obj };}function _typeof(obj) {"@babel/helpers - typeof";if (typeof Symbol === "function" && typeof Symbol.iterator === "symbol") {_typeof = function _typeof(obj) {return typeof obj;};} else {_typeof = function _typeof(obj) {return obj && typeof Symbol === "function" && obj.constructor === Symbol && obj !== Symbol.prototype ? "symbol" : typeof obj;};}return _typeof(obj);}function asyncGeneratorStep(gen, resolve, reject, _next, _throw, key, arg) {try {var info = gen[key](arg);var value = info.value;} catch (error) {reject(error);return;}if (info.done) {resolve(value);} else {Promise.resolve(value).then(_next, _throw);}}function _asyncToGenerator(fn) {return function () {var self = this,args = arguments;return new Promise(function (resolve, reject) {var gen = fn.apply(self, args);function _next(value) {asyncGeneratorStep(gen, resolve, reject, _next, _throw, "next", value);}function _throw(err) {asyncGeneratorStep(gen, resolve, reject, _next, _throw, "throw", err);}_next(undefined);});};}function _classCallCheck(instance, Constructor) {if (!(instance instanceof Constructor)) {throw new TypeError("Cannot call a class as a function");}}function _defineProperties(target, props) {for (var i = 0; i < props.length; i++) {var descriptor = props[i];descriptor.enumerable = descriptor.enumerable || false;descriptor.configurable = true;if ("value" in descriptor) descriptor.writable = true;Object.defineProperty(target, descriptor.key, descriptor);}}function _createClass(Constructor, protoProps, staticProps) {if (protoProps) _defineProperties(Constructor.prototype, protoProps);if (staticProps) _defineProperties(Constructor, staticProps);return Constructor;}function _inherits(subClass, superClass) {if (typeof superClass !== "function" && superClass !== null) {throw new TypeError("Super expression must either be null or a function");}subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, writable: true, configurable: true } });if (superClass) _setPrototypeOf(subClass, superClass);}function _setPrototypeOf(o, p) {_setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) {o.__proto__ = p;return o;};return _setPrototypeOf(o, p);}function _createSuper(Derived) {var hasNativeReflectConstruct = _isNativeReflectConstruct();return function _createSuperInternal() {var Super = _getPrototypeOf(Derived),result;if (hasNativeReflectConstruct) {var NewTarget = _getPrototypeOf(this).constructor;result = Reflect.construct(Super, arguments, NewTarget);} else {result = Super.apply(this, arguments);}return _possibleConstructorReturn(this, result);};}function _possibleConstructorReturn(self, call) {if (call && (_typeof(call) === "object" || typeof call === "function")) {return call;}return _assertThisInitialized(self);}function _assertThisInitialized(self) {if (self === void 0) {throw new ReferenceError("this hasn't been initialised - super() hasn't been called");}return self;}function _isNativeReflectConstruct() {if (typeof Reflect === "undefined" || !Reflect.construct) return false;if (Reflect.construct.sham) return false;if (typeof Proxy === "function") return true;try {Date.prototype.toString.call(Reflect.construct(Date, [], function () {}));return true;} catch (e) {return false;}}function _getPrototypeOf(o) {_getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) {return o.__proto__ || Object.getPrototypeOf(o);};return _getPrototypeOf(o);}

/**
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * This class manages the Signature node within the parent signatures.xml > signature node.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       * Note: the signature w3 spec uses snake case on names and attributes
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       */var
Signature = /*#__PURE__*/function (_DataElement) {_inherits(Signature, _DataElement);var _super = _createSuper(Signature);
  function Signature() {var _this;var epubLocation = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : "";var id = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : "sig";_classCallCheck(this, Signature);
    // Note that the Signature and children tags need to be capitalized

    _this = _super.call(this, "Signature", undefined, {
      id: id,
      xmlns: "http://www.w3.org/2000/09/xmldsig#" });


    _this.signedInfo = new _signatureSignedInfo["default"]();
    _this.signatureValue = new _signatureValue["default"]();
    _this.keyInfo = new _dataElement["default"]("KeyInfo");
    _this.object = new _dataElement["default"]("Object");
    _this.object.manifest = new _signatureManifest["default"]();
    _this.epubLocation = epubLocation;return _this;
  }

  /**
     * This will create a complete signature to add to the signatures.xml.
     * Often, the signatures.xml file itself would not be included in the manifest,
     * however to allow validation of the signature.xml file itelf, the envelope
     * transform can be used. In this case, adding or removing a signature
     * invalidates the signatures.xml file.
     *
     * The envelope transform removes the whole signature element containing the
     * transform from the signing process. In a Signatures.xml file, any previous
     * Signature nodes will be included in the signing.
     *
     * see:
     * https://www.w3.org/publishing/epub32/epub-ocf.html#sec-container-metainf-signatures.xml
     * https://www.w3.org/TR/xmldsig-core/#sec-EnvelopedSignature
     *
     * In the situation where epub watermarking chain of custody is desired,
     * each previous signatures.xml signature should be retained for self-validation against
     * the digest hash of the signature's manifest, but have the signature iteslf become
     * invalidated. Each subsequent signature will be signed with the full
     * signature history, recording a secure chain of signatures.
     */

  /**
         * Sign the signature
         * Signing with a privateKey should only be allowed in a node environment
         * https://github.com/PeculiarVentures/xmldsigjs#creating-a-xmldsig-signature
         * https://www.w3.org/TR/WebCryptoAPI/#algorithms
         * https://www.w3.org/TR/xmldsig-core/#sec-KeyValue
         */_createClass(Signature, [{ key: "sign", value: function () {var _sign = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee(
      privateKey, publicKey) {var signer, rawXml, xmlData, algorithm, options, xmlsigjsXml, reparsedXmlData, signatureValueData, keyInfoData;return regeneratorRuntime.wrap(function _callee$(_context) {while (1) {switch (_context.prev = _context.next) {case 0:
                signer = new xmldsigjs.SignedXml();

                // https://nodejs.org/api/crypto.html#crypto_crypto_generatekeypair_type_options_callback
                // see https://www.w3.org/TR/xmldsig-core/#sec-KeyValue
                // const privateKey = undefined;
                // const publicKey = undefined;
                _context.next = 3;return (
                  this.object.manifest.getXml());case 3:rawXml = _context.sent;
                xmlData = xmldsigjs.Parse(rawXml);
                algorithm = { name: "RSASSA-PKCS1-v1_5" };
                options = {
                  id: this.id, // id of signature
                  keyValue: publicKey,
                  references: [
                  {
                    id: "ref_id", // ref id,
                    uri: "#".concat(this.object.manifest.id), // ref uri
                    hash: "SHA-256", // hash algo to use
                    transforms: ["c14n"] // array of transforms to use
                  }] };_context.next = 9;return (


                  signer.Sign(algorithm, privateKey, xmlData, options));case 9:

                // TODO find better allternative to this is hacky way to interoperate between xml2js and xmlsigjs's own xml lib.
                xmlsigjsXml = signer.toString();_context.next = 12;return (
                  (0, _xml.parseXml)(xmlsigjsXml));case 12:reparsedXmlData = _context.sent;

                signatureValueData = reparsedXmlData['ds:signature']['ds:signaturevalue'];
                keyInfoData = reparsedXmlData['ds:signature']['ds:keyinfo'];_context.next = 17;return (

                  this.parseXmlObj({ SignatureValue: signatureValueData }));case 17:this.signatureValue = _context.sent;_context.next = 20;return (
                  this.parseXmlObj({ KeyInfo: keyInfoData }));case 20:this.keyInfo = _context.sent;

                console.log("Sign result", this.getXml(true));case 22:case "end":return _context.stop();}}}, _callee, this);}));function sign(_x, _x2) {return _sign.apply(this, arguments);}return sign;}()


    /**
                                                                                                                                                                                                              * Look for file in manifest and update the reference if it exists, otherwise create a new reference
                                                                                                                                                                                                              * @param {string} location location of file, relative to epub root
                                                                                                                                                                                                              * @param {array} transforms array of xmldsigjs transforms
                                                                                                                                                                                                              * @param {string} digestMethod xmldsigjs diest method
                                                                                                                                                                                                              * @param {string} digestValue option base64 encoded digest value. A new digest will be generated if omited
                                                                                                                                                                                                              */ }, { key: "addOrUpdateManifestReference", value: function () {var _addOrUpdateManifestReference = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee2(

      location) {var transforms,digestMethod,digestValue,existing,_args2 = arguments;return regeneratorRuntime.wrap(function _callee2$(_context2) {while (1) {switch (_context2.prev = _context2.next) {case 0:
                transforms = _args2.length > 1 && _args2[1] !== undefined ? _args2[1] : ["http://www.w3.org/TR/2001/REC-xml-c14n-2001031"];
                digestMethod = _args2.length > 2 && _args2[2] !== undefined ? _args2[2] : "http://www.w3.org/2001/04/xmlenc#sha256";
                digestValue = _args2.length > 3 && _args2[3] !== undefined ? _args2[3] : undefined;

                existing = this.manifest.getReference(location);if (!

                existing) {_context2.next = 15;break;}
                existing.uri = location;
                existing.transforms = transforms;
                existing.digestMethod = digestMethod;if (
                digestValue) {_context2.next = 12;break;}_context2.next = 11;return (
                  this.generateFileDigest(location, digestMethod));case 11:digestValue = _context2.sent;case 12:

                existing.digestValue = digestValue;_context2.next = 17;break;case 15:_context2.next = 17;return (

                  this.addManifestReference(
                  location,
                  transforms,
                  digestMethod,
                  digestValue));case 17:case "end":return _context2.stop();}}}, _callee2, this);}));function addOrUpdateManifestReference(_x3) {return _addOrUpdateManifestReference.apply(this, arguments);}return addOrUpdateManifestReference;}()




    /**
                                                                                                                                                                                                                                                      * Create a base64 encoded digest hash of a file.
                                                                                                                                                                                                                                                      * https://www.w3.org/TR/2008/REC-xmldsig-core-20080610/#sec-EnvelopedSignature
                                                                                                                                                                                                                                                      * @param {string} location the location of the file relative to the epub root
                                                                                                                                                                                                                                                      */ }, { key: "generateFileDigest", value: function () {var _generateFileDigest = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee3(
      location, digestMethod) {var xmlExts, digest, fileExt, resolvedLocation, data, fileData, transform, node, digestValue, base64Digest;return regeneratorRuntime.wrap(function _callee3$(_context3) {while (1) {switch (_context3.prev = _context3.next) {case 0:
                xmlExts = [".xml", ".xhtml", "html", ".opf", ".ncx"];

                digest = xmldsigjs.CryptoConfig.CreateHashAlgorithm(digestMethod);

                fileExt = _path["default"].extname(location);

                resolvedLocation = _path["default"].resolve(this.epubLocation, location);if (!




                xmlExts.includes(fileExt)) {_context3.next = 15;break;}_context3.next = 7;return (


                  _fileManager["default"].readFile(resolvedLocation, "utf8"));case 7:fileData = _context3.sent;

                if (!fileData) {
                  console.error("Error: file could not be loaded", resolvedLocation);
                }

                transform = new xmldsigjs.XmlDsigC14NTransform();
                node = xmldsigjs.Parse(fileData).documentElement;
                transform.LoadInnerXml(node);
                data = transform.GetOutput();_context3.next = 18;break;case 15:_context3.next = 17;return (



                  _fileManager["default"].readFile(resolvedLocation));case 17:data = _context3.sent;case 18:_context3.prev = 18;_context3.next = 21;return (



                  digest.Digest(data));case 21:digestValue = _context3.sent;

                // the fileHash should be represented as a base64 string
                base64Digest = Buffer.from(digestValue).toString("base64");return _context3.abrupt("return",
                base64Digest);case 26:_context3.prev = 26;_context3.t0 = _context3["catch"](18);

                console.error("error hashing file", _context3.t0);return _context3.abrupt("return");case 30:case "end":return _context3.stop();}}}, _callee3, this, [[18, 26]]);}));function generateFileDigest(_x4, _x5) {return _generateFileDigest.apply(this, arguments);}return generateFileDigest;}()



    /**
                                                                                                                                                                                                                                                                                                             * Add a manifest reference to the signature. Using an Object > Manifest is the recommended signature form
                                                                                                                                                                                                                                                                                                             * in the epub spec. see: https://www.w3.org/publishing/epub32/epub-ocf.html#sec-container-metainf-signatures.xml
                                                                                                                                                                                                                                                                                                             * A comment in the example notes that xml/html files should be canonicalized before the digest is produced -
                                                                                                                                                                                                                                                                                                             * that is the approach taken below.
                                                                                                                                                                                                                                                                                                             *
                                                                                                                                                                                                                                                                                                             * TODO! this does not apply the transforms. Currently all xml files are normalized downstream.
                                                                                                                                                                                                                                                                                                             * (see generateFileDigest above). or that transforms happened upstream and included in provided digestValue
                                                                                                                                                                                                                                                                                                             *
                                                                                                                                                                                                                                                                                                             * Note that WebCrypto does not accept streams, so the entire file must be loaded into memory. Node has a 1gb
                                                                                                                                                                                                                                                                                                             * file size limit (?) - so large files cannot be digested.
                                                                                                                                                                                                                                                                                                             * see:
                                                                                                                                                                                                                                                                                                             * https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/digest
                                                                                                                                                                                                                                                                                                             * https://github.com/w3c/webcrypto/issues/
                                                                                                                                                                                                                                                                                                             * https://www.w3.org/TR/2008/REC-xmldsig-core-20080610/#sec-EnvelopedSignature
                                                                                                                                                                                                                                                                                                             *
                                                                                                                                                                                                                                                                                                             * @param {string} location - path to the resource, relative to the epub root
                                                                                                                                                                                                                                                                                                             * @param {string} digestMethod - the digest standard to use. see https://github.com/PeculiarVentures/xmldsigjs
                                                                                                                                                                                                                                                                                                             */ }, { key: "addManifestReference", value: function () {var _addManifestReference = _asyncToGenerator( /*#__PURE__*/regeneratorRuntime.mark(function _callee4(

      location) {var transforms,digestMethod,digestValue,base64Digest,_args4 = arguments;return regeneratorRuntime.wrap(function _callee4$(_context4) {while (1) {switch (_context4.prev = _context4.next) {case 0:
                transforms = _args4.length > 1 && _args4[1] !== undefined ? _args4[1] : ["http://www.w3.org/TR/2001/REC-xml-c14n-2001031"];
                digestMethod = _args4.length > 2 && _args4[2] !== undefined ? _args4[2] : "http://www.w3.org/2001/04/xmlenc#sha256";
                digestValue = _args4.length > 3 && _args4[3] !== undefined ? _args4[3] : undefined;if (!

                digestValue) {_context4.next = 7;break;}
                // if digestValue is provided, use that
                this.object.manifest.addReference(
                location,
                transforms,
                digestMethod,
                digestValue);_context4.next = 11;break;case 7:_context4.next = 9;return (



                  this.generateFileDigest(
                  location,
                  digestMethod));case 9:base64Digest = _context4.sent;


                if (base64Digest) {
                  this.object.manifest.addReference(
                  location,
                  transforms,
                  digestMethod,
                  base64Digest);

                }case 11:case "end":return _context4.stop();}}}, _callee4, this);}));function addManifestReference(_x6) {return _addManifestReference.apply(this, arguments);}return addManifestReference;}() }]);return Signature;}(_dataElement["default"]);exports["default"] = Signature;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zaWduYXR1cmUuanMiXSwibmFtZXMiOlsiU2lnbmF0dXJlIiwiZXB1YkxvY2F0aW9uIiwiaWQiLCJ1bmRlZmluZWQiLCJ4bWxucyIsInNpZ25lZEluZm8iLCJTaWduYXR1cmVTaWduZWRJbmZvIiwic2lnbmF0dXJlVmFsdWUiLCJTaWduYXR1cmVWYWx1ZSIsImtleUluZm8iLCJEYXRhRWxlbWVudCIsIm9iamVjdCIsIm1hbmlmZXN0IiwiU2lnbmF0dXJlTWFuaWZlc3QiLCJwcml2YXRlS2V5IiwicHVibGljS2V5Iiwic2lnbmVyIiwieG1sZHNpZ2pzIiwiU2lnbmVkWG1sIiwiZ2V0WG1sIiwicmF3WG1sIiwieG1sRGF0YSIsIlBhcnNlIiwiYWxnb3JpdGhtIiwibmFtZSIsIm9wdGlvbnMiLCJrZXlWYWx1ZSIsInJlZmVyZW5jZXMiLCJ1cmkiLCJoYXNoIiwidHJhbnNmb3JtcyIsIlNpZ24iLCJ4bWxzaWdqc1htbCIsInRvU3RyaW5nIiwicmVwYXJzZWRYbWxEYXRhIiwic2lnbmF0dXJlVmFsdWVEYXRhIiwia2V5SW5mb0RhdGEiLCJwYXJzZVhtbE9iaiIsIktleUluZm8iLCJjb25zb2xlIiwibG9nIiwibG9jYXRpb24iLCJkaWdlc3RNZXRob2QiLCJkaWdlc3RWYWx1ZSIsImV4aXN0aW5nIiwiZ2V0UmVmZXJlbmNlIiwiZ2VuZXJhdGVGaWxlRGlnZXN0IiwiYWRkTWFuaWZlc3RSZWZlcmVuY2UiLCJ4bWxFeHRzIiwiZGlnZXN0IiwiQ3J5cHRvQ29uZmlnIiwiQ3JlYXRlSGFzaEFsZ29yaXRobSIsImZpbGVFeHQiLCJwYXRoIiwiZXh0bmFtZSIsInJlc29sdmVkTG9jYXRpb24iLCJyZXNvbHZlIiwiaW5jbHVkZXMiLCJGaWxlTWFuYWdlciIsInJlYWRGaWxlIiwiZmlsZURhdGEiLCJlcnJvciIsInRyYW5zZm9ybSIsIlhtbERzaWdDMTROVHJhbnNmb3JtIiwibm9kZSIsImRvY3VtZW50RWxlbWVudCIsIkxvYWRJbm5lclhtbCIsImRhdGEiLCJHZXRPdXRwdXQiLCJEaWdlc3QiLCJiYXNlNjREaWdlc3QiLCJCdWZmZXIiLCJmcm9tIiwiYWRkUmVmZXJlbmNlIl0sIm1hcHBpbmdzIjoidUdBQUE7QUFDQTs7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0Esa0M7O0FBRUE7Ozs7QUFJcUJBLFM7QUFDbkIsdUJBQTJDLGVBQS9CQyxZQUErQix1RUFBaEIsRUFBZ0IsS0FBWkMsRUFBWSx1RUFBUCxLQUFPO0FBQ3pDOztBQUVBLDhCQUFNLFdBQU4sRUFBbUJDLFNBQW5CLEVBQThCO0FBQzVCRCxNQUFBQSxFQUFFLEVBQUVBLEVBRHdCO0FBRTVCRSxNQUFBQSxLQUFLLEVBQUUsb0NBRnFCLEVBQTlCOzs7QUFLQSxVQUFLQyxVQUFMLEdBQWtCLElBQUlDLCtCQUFKLEVBQWxCO0FBQ0EsVUFBS0MsY0FBTCxHQUFzQixJQUFJQywwQkFBSixFQUF0QjtBQUNBLFVBQUtDLE9BQUwsR0FBZSxJQUFJQyx1QkFBSixDQUFnQixTQUFoQixDQUFmO0FBQ0EsVUFBS0MsTUFBTCxHQUFjLElBQUlELHVCQUFKLENBQWdCLFFBQWhCLENBQWQ7QUFDQSxVQUFLQyxNQUFMLENBQVlDLFFBQVosR0FBdUIsSUFBSUMsNkJBQUosRUFBdkI7QUFDQSxVQUFLWixZQUFMLEdBQW9CQSxZQUFwQixDQWJ5QztBQWMxQzs7QUFFRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXNCQTs7Ozs7OztBQU9XYSxNQUFBQSxVLEVBQVlDLFM7QUFDZkMsZ0JBQUFBLE0sR0FBUyxJQUFJQyxTQUFTLENBQUNDLFNBQWQsRTs7QUFFZjtBQUNBO0FBQ0E7QUFDQTs7QUFFcUIsdUJBQUtQLE1BQUwsQ0FBWUMsUUFBWixDQUFxQk8sTUFBckIsRSxTQUFmQyxNO0FBQ0FDLGdCQUFBQSxPLEdBQVVKLFNBQVMsQ0FBQ0ssS0FBVixDQUFnQkYsTUFBaEIsQztBQUNWRyxnQkFBQUEsUyxHQUFZLEVBQUVDLElBQUksRUFBRSxtQkFBUixFO0FBQ1pDLGdCQUFBQSxPLEdBQVU7QUFDZHZCLGtCQUFBQSxFQUFFLEVB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QUFBLFlBSEY7QUFJRTRCLGtCQUFBQSxZQUpGOztBQU1ELGlCLG9OQW5OZ0M1RCx1QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgKiBhcyB4bWxkc2lnanMgZnJvbSBcInhtbGRzaWdqc1wiO1xuXG5pbXBvcnQgRGF0YUVsZW1lbnQgZnJvbSBcIi4vZGF0YS1lbGVtZW50XCI7XG5pbXBvcnQgRmlsZU1hbmFnZXIgZnJvbSBcIi4vZmlsZS1tYW5hZ2VyXCI7XG5pbXBvcnQgU2lnbmF0dXJlTWFuaWZlc3QgZnJvbSBcIi4vc2lnbmF0dXJlLW1hbmlmZXN0XCI7XG5pbXBvcnQgU2lnbmF0dXJlU2lnbmVkSW5mbyBmcm9tIFwiLi9zaWduYXR1cmUtc2lnbmVkLWluZm9cIjtcbmltcG9ydCBTaWduYXR1cmVWYWx1ZSBmcm9tIFwiLi9zaWduYXR1cmUtdmFsdWVcIjtcbmltcG9ydCB7IHBhcnNlWG1sIH0gZnJvbSBcIi4vdXRpbHMveG1sXCI7XG5cbi8qKlxuICogVGhpcyBjbGFzcyBtYW5hZ2VzIHRoZSBTaWduYXR1cmUgbm9kZSB3aXRoaW4gdGhlIHBhcmVudCBzaWduYXR1cmVzLnhtbCA+IHNpZ25hdHVyZSBub2RlLlxuICogTm90ZTogdGhlIHNpZ25hdHVyZSB3MyBzcGVjIHVzZXMgc25ha2UgY2FzZSBvbiBuYW1lcyBhbmQgYXR0cmlidXRlc1xuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBTaWduYXR1cmUgZXh0ZW5kcyBEYXRhRWxlbWVudCB7XG4gIGNvbnN0cnVjdG9yKGVwdWJMb2NhdGlvbiA9IFwiXCIsIGlkID0gXCJzaWdcIikge1xuICAgIC8vIE5vdGUgdGhhdCB0aGUgU2lnbmF0dXJlIGFuZCBjaGlsZHJlbiB0YWdzIG5lZWQgdG8gYmUgY2FwaXRhbGl6ZWRcblxuICAgIHN1cGVyKFwiU2lnbmF0dXJlXCIsIHVuZGVmaW5lZCwge1xuICAgICAgaWQ6IGlkLFxuICAgICAgeG1sbnM6IFwiaHR0cDovL3d3dy53My5vcmcvMjAwMC8wOS94bWxkc2lnI1wiLFxuICAgIH0pO1xuXG4gICAgdGhpcy5zaWduZWRJbmZvID0gbmV3IFNpZ25hdHVyZVNpZ25lZEluZm8oKTtcbiAgICB0aGlzLnNpZ25hdHVyZVZhbHVlID0gbmV3IFNpZ25hdHVyZVZhbHVlKCk7XG4gICAgdGhpcy5rZXlJbmZvID0gbmV3IERhdGFFbGVtZW50KFwiS2V5SW5mb1wiKTtcbiAgICB0aGlzLm9iamVjdCA9IG5ldyBEYXRhRWxlbWVudChcIk9iamVjdFwiKTtcbiAgICB0aGlzLm9iamVjdC5tYW5pZmVzdCA9IG5ldyBTaWduYXR1cmVNYW5pZmVzdCgpO1xuICAgIHRoaXMuZXB1YkxvY2F0aW9uID0gZXB1YkxvY2F0aW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoaXMgd2lsbCBjcmVhdGUgYSBjb21wbGV0ZSBzaWduYXR1cmUgdG8gYWRkIHRvIHRoZSBzaWduYXR1cmVzLnhtbC5cbiAgICogT2Z0ZW4sIHRoZSBzaWduYXR1cmVzLnhtbCBmaWxlIGl0c2VsZiB3b3VsZCBub3QgYmUgaW5jbHVkZWQgaW4gdGhlIG1hbmlmZXN0LFxuICAgKiBob3dldmVyIHRvIGFsbG93IHZhbGlkYXRpb24gb2YgdGhlIHNpZ25hdHVyZS54bWwgZmlsZSBpdGVsZiwgdGhlIGVudmVsb3BlXG4gICAqIHRyYW5zZm9ybSBjYW4gYmUgdXNlZC4gSW4gdGhpcyBjYXNlLCBhZGRpbmcgb3IgcmVtb3ZpbmcgYSBzaWduYXR1cmVcbiAgICogaW52YWxpZGF0ZXMgdGhlIHNpZ25hdHVyZXMueG1sIGZpbGUuXG4gICAqXG4gICAqIFRoZSBlbnZlbG9wZSB0cmFuc2Zvcm0gcmVtb3ZlcyB0aGUgd2hvbGUgc2lnbmF0dXJlIGVsZW1lbnQgY29udGFpbmluZyB0aGVcbiAgICogdHJhbnNmb3JtIGZyb20gdGhlIHNpZ25pbmcgcHJvY2Vzcy4gSW4gYSBTaWduYXR1cmVzLnhtbCBmaWxlLCBhbnkgcHJldmlvdXNcbiAgICogU2lnbmF0dXJlIG5vZGVzIHdpbGwgYmUgaW5jbHVkZWQgaW4gdGhlIHNpZ25pbmcuXG4gICAqXG4gICAqIHNlZTpcbiAgICogaHR0cHM6Ly93d3cudzMub3JnL3B1Ymxpc2hpbmcvZXB1YjMyL2VwdWItb2NmLmh0bWwjc2VjLWNvbnRhaW5lci1tZXRhaW5mLXNpZ25hdHVyZXMueG1sXG4gICAqIGh0dHBzOi8vd3d3LnczLm9yZy9UUi94bWxkc2lnLWNvcmUvI3NlYy1FbnZlbG9wZWRTaWduYXR1cmVcbiAgICpcbiAgICogSW4gdGhlIHNpdHVhdGlvbiB3aGVyZSBlcHViIHdhdGVybWFya2luZyBjaGFpbiBvZiBjdXN0b2R5IGlzIGRlc2lyZWQsXG4gICAqIGVhY2ggcHJldmlvdXMgc2lnbmF0dXJlcy54bWwgc2lnbmF0dXJlIHNob3VsZCBiZSByZXRhaW5lZCBmb3Igc2VsZi12YWxpZGF0aW9uIGFnYWluc3RcbiAgICogdGhlIGRpZ2VzdCBoYXNoIG9mIHRoZSBzaWduYXR1cmUncyBtYW5pZmVzdCwgYnV0IGhhdmUgdGhlIHNpZ25hdHVyZSBpdGVzbGYgYmVjb21lXG4gICAqIGludmFsaWRhdGVkLiBFYWNoIHN1YnNlcXVlbnQgc2lnbmF0dXJlIHdpbGwgYmUgc2lnbmVkIHdpdGggdGhlIGZ1bGxcbiAgICogc2lnbmF0dXJlIGhpc3RvcnksIHJlY29yZGluZyBhIHNlY3VyZSBjaGFpbiBvZiBzaWduYXR1cmVzLlxuICAgKi9cblxuICAvKipcbiAgICogU2lnbiB0aGUgc2lnbmF0dXJlXG4gICAqIFNpZ25pbmcgd2l0aCBhIHByaXZhdGVLZXkgc2hvdWxkIG9ubHkgYmUgYWxsb3dlZCBpbiBhIG5vZGUgZW52aXJvbm1lbnRcbiAgICogaHR0cHM6Ly9naXRodWIuY29tL1BlY3VsaWFyVmVudHVyZXMveG1sZHNpZ2pzI2NyZWF0aW5nLWEteG1sZHNpZy1zaWduYXR1cmVcbiAgICogaHR0cHM6Ly93d3cudzMub3JnL1RSL1dlYkNyeXB0b0FQSS8jYWxnb3JpdGhtc1xuICAgKiBodHRwczovL3d3dy53My5vcmcvVFIveG1sZHNpZy1jb3JlLyNzZWMtS2V5VmFsdWVcbiAgICovXG4gIGFzeW5jIHNpZ24ocHJpdmF0ZUtleSwgcHVibGljS2V5KSB7XG4gICAgY29uc3Qgc2lnbmVyID0gbmV3IHhtbGRzaWdqcy5TaWduZWRYbWwoKTtcblxuICAgIC8vIGh0dHBzOi8vbm9kZWpzLm9yZy9hcGkvY3J5cHRvLmh0bWwjY3J5cHRvX2NyeXB0b19nZW5lcmF0ZWtleXBhaXJfdHlwZV9vcHRpb25zX2NhbGxiYWNrXG4gICAgLy8gc2VlIGh0dHBzOi8vd3d3LnczLm9yZy9UUi94bWxkc2lnLWNvcmUvI3NlYy1LZXlWYWx1ZVxuICAgIC8vIGNvbnN0IHByaXZhdGVLZXkgPSB1bmRlZmluZWQ7XG4gICAgLy8gY29uc3QgcHVibGljS2V5ID0gdW5kZWZpbmVkO1xuXG4gICAgY29uc3QgcmF3WG1sID0gYXdhaXQgdGhpcy5vYmplY3QubWFuaWZlc3QuZ2V0WG1sKCk7XG4gICAgY29uc3QgeG1sRGF0YSA9IHhtbGRzaWdqcy5QYXJzZShyYXdYbWwpO1xuICAgIGNvbnN0IGFsZ29yaXRobSA9IHsgbmFtZTogXCJSU0FTU0EtUEtDUzEtdjFfNVwiIH07XG4gICAgY29uc3Qgb3B0aW9ucyA9IHtcbiAgICAgIGlkOiB0aGlzLmlkLCAvLyBpZCBvZiBzaWduYXR1cmVcbiAgICAgIGtleVZhbHVlOiBwdWJsaWNLZXksXG4gICAgICByZWZlcmVuY2VzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBpZDogXCJyZWZfaWRcIiwgLy8gcmVmIGlkLFxuICAgICAgICAgIHVyaTogYCMke3RoaXMub2JqZWN0Lm1hbmlmZXN0LmlkfWAsIC8vIHJlZiB1cmlcbiAgICAgICAgICBoYXNoOiBcIlNIQS0yNTZcIiwgLy8gaGFzaCBhbGdvIHRvIHVzZVxuICAgICAgICAgIHRyYW5zZm9ybXM6IFtcImMxNG5cIl0sIC8vIGFycmF5IG9mIHRyYW5zZm9ybXMgdG8gdXNlXG4gICAgICAgIH0sXG4gICAgICBdLFxuICAgIH07XG4gICAgYXdhaXQgc2lnbmVyLlNpZ24oYWxnb3JpdGhtLCBwcml2YXRlS2V5LCB4bWxEYXRhLCBvcHRpb25zKTtcblxuICAgIC8vIFRPRE8gZmluZCBiZXR0ZXIgYWxsdGVybmF0aXZlIHRvIHRoaXMgaXMgaGFja3kgd2F5IHRvIGludGVyb3BlcmF0ZSBiZXR3ZWVuIHhtbDJqcyBhbmQgeG1sc2lnanMncyBvd24geG1sIGxpYi5cbiAgICBjb25zdCB4bWxzaWdqc1htbCA9IHNpZ25lci50b1N0cmluZygpO1xuICAgIGNvbnN0IHJlcGFyc2VkWG1sRGF0YSA9IGF3YWl0IHBhcnNlWG1sKHhtbHNpZ2pzWG1sKTtcblxuICAgIGNvbnN0IHNpZ25hdHVyZVZhbHVlRGF0YSA9IHJlcGFyc2VkWG1sRGF0YVsnZHM6c2lnbmF0dXJlJ11bJ2RzOnNpZ25hdHVyZXZhbHVlJ107XG4gICAgY29uc3Qga2V5SW5mb0RhdGEgPSByZXBhcnNlZFhtbERhdGFbJ2RzOnNpZ25hdHVyZSddWydkczprZXlpbmZvJ107XG5cbiAgICB0aGlzLnNpZ25hdHVyZVZhbHVlID0gYXdhaXQgdGhpcy5wYXJzZVhtbE9iaih7U2lnbmF0dXJlVmFsdWU6IHNpZ25hdHVyZVZhbHVlRGF0YX0pO1xuICAgIHRoaXMua2V5SW5mbyA9IGF3YWl0IHRoaXMucGFyc2VYbWxPYmooe0tleUluZm86IGtleUluZm9EYXRhfSk7XG5cbiAgICBjb25zb2xlLmxvZyhcIlNpZ24gcmVzdWx0XCIsIHRoaXMuZ2V0WG1sKHRydWUpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBMb29rIGZvciBmaWxlIGluIG1hbmlmZXN0IGFuZCB1cGRhdGUgdGhlIHJlZmVyZW5jZSBpZiBpdCBleGlzdHMsIG90aGVyd2lzZSBjcmVhdGUgYSBuZXcgcmVmZXJlbmNlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhdGlvbiBsb2NhdGlvbiBvZiBmaWxlLCByZWxhdGl2ZSB0byBlcHViIHJvb3RcbiAgICogQHBhcmFtIHthcnJheX0gdHJhbnNmb3JtcyBhcnJheSBvZiB4bWxkc2lnanMgdHJhbnNmb3Jtc1xuICAgKiBAcGFyYW0ge3N0cmluZ30gZGlnZXN0TWV0aG9kIHhtbGRzaWdqcyBkaWVzdCBtZXRob2RcbiAgICogQHBhcmFtIHtzdHJpbmd9IGRpZ2VzdFZhbHVlIG9wdGlvbiBiYXNlNjQgZW5jb2RlZCBkaWdlc3QgdmFsdWUuIEEgbmV3IGRpZ2VzdCB3aWxsIGJlIGdlbmVyYXRlZCBpZiBvbWl0ZWRcbiAgICovXG4gIGFzeW5jIGFkZE9yVXBkYXRlTWFuaWZlc3RSZWZlcmVuY2UoXG4gICAgbG9jYXRpb24sXG4gICAgdHJhbnNmb3JtcyA9IFtcImh0dHA6Ly93d3cudzMub3JnL1RSLzIwMDEvUkVDLXhtbC1jMTRuLTIwMDEwMzFcIl0sXG4gICAgZGlnZXN0TWV0aG9kID0gXCJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNzaGEyNTZcIixcbiAgICBkaWdlc3RWYWx1ZSA9IHVuZGVmaW5lZFxuICApIHtcbiAgICBjb25zdCBleGlzdGluZyA9IHRoaXMubWFuaWZlc3QuZ2V0UmVmZXJlbmNlKGxvY2F0aW9uKTtcblxuICAgIGlmIChleGlzdGluZykge1xuICAgICAgZXhpc3RpbmcudXJpID0gbG9jYXRpb247XG4gICAgICBleGlzdGluZy50cmFuc2Zvcm1zID0gdHJhbnNmb3JtcztcbiAgICAgIGV4aXN0aW5nLmRpZ2VzdE1ldGhvZCA9IGRpZ2VzdE1ldGhvZDtcbiAgICAgIGlmICghZGlnZXN0VmFsdWUpIHtcbiAgICAgICAgZGlnZXN0VmFsdWUgPSBhd2FpdCB0aGlzLmdlbmVyYXRlRmlsZURpZ2VzdChsb2NhdGlvbiwgZGlnZXN0TWV0aG9kKTtcbiAgICAgIH1cbiAgICAgIGV4aXN0aW5nLmRpZ2VzdFZhbHVlID0gZGlnZXN0VmFsdWU7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRkTWFuaWZlc3RSZWZlcmVuY2UoXG4gICAgICAgIGxvY2F0aW9uLFxuICAgICAgICB0cmFuc2Zvcm1zLFxuICAgICAgICBkaWdlc3RNZXRob2QsXG4gICAgICAgIGRpZ2VzdFZhbHVlXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBiYXNlNjQgZW5jb2RlZCBkaWdlc3QgaGFzaCBvZiBhIGZpbGUuXG4gICAqIGh0dHBzOi8vd3d3LnczLm9yZy9UUi8yMDA4L1JFQy14bWxkc2lnLWNvcmUtMjAwODA2MTAvI3NlYy1FbnZlbG9wZWRTaWduYXR1cmVcbiAgICogQHBhcmFtIHtzdHJpbmd9IGxvY2F0aW9uIHRoZSBsb2NhdGlvbiBvZiB0aGUgZmlsZSByZWxhdGl2ZSB0byB0aGUgZXB1YiByb290XG4gICAqL1xuICBhc3luYyBnZW5lcmF0ZUZpbGVEaWdlc3QobG9jYXRpb24sIGRpZ2VzdE1ldGhvZCkge1xuICAgIGNvbnN0IHhtbEV4dHMgPSBbXCIueG1sXCIsIFwiLnhodG1sXCIsIFwiaHRtbFwiLCBcIi5vcGZcIiwgXCIubmN4XCJdO1xuXG4gICAgY29uc3QgZGlnZXN0ID0geG1sZHNpZ2pzLkNyeXB0b0NvbmZpZy5DcmVhdGVIYXNoQWxnb3JpdGhtKGRpZ2VzdE1ldGhvZCk7XG5cbiAgICBjb25zdCBmaWxlRXh0ID0gcGF0aC5leHRuYW1lKGxvY2F0aW9uKTtcblxuICAgIGNvbnN0IHJlc29sdmVkTG9jYXRpb24gPSBwYXRoLnJlc29sdmUodGhpcy5lcHViTG9jYXRpb24sIGxvY2F0aW9uKTtcblxuICAgIGxldCBkYXRhO1xuXG4gICAgLyogWG1sIGZpbGVzIHNob3VsZCBiZSBjYW5vbmljYWxpemVkICovXG4gICAgaWYgKHhtbEV4dHMuaW5jbHVkZXMoZmlsZUV4dCkpIHtcbiAgICAgIC8vIE5PVEU6IHRoZSBzaWduYXR1cmVzLnhtbCBtdXN0IGJlIGluIHRoZSBNRVRBLUlORiBmb2xkZXIgYXQgdGhlIGVwdWIgcm9vdFxuXG4gICAgICBjb25zdCBmaWxlRGF0YSA9IGF3YWl0IEZpbGVNYW5hZ2VyLnJlYWRGaWxlKHJlc29sdmVkTG9jYXRpb24sIFwidXRmOFwiKTtcblxuICAgICAgaWYgKCFmaWxlRGF0YSkge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiRXJyb3I6IGZpbGUgY291bGQgbm90IGJlIGxvYWRlZFwiLCByZXNvbHZlZExvY2F0aW9uKTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgdHJhbnNmb3JtID0gbmV3IHhtbGRzaWdqcy5YbWxEc2lnQzE0TlRyYW5zZm9ybSgpO1xuICAgICAgY29uc3Qgbm9kZSA9IHhtbGRzaWdqcy5QYXJzZShmaWxlRGF0YSkuZG9jdW1lbnRFbGVtZW50O1xuICAgICAgdHJhbnNmb3JtLkxvYWRJbm5lclhtbChub2RlKTtcbiAgICAgIGRhdGEgPSB0cmFuc2Zvcm0uR2V0T3V0cHV0KCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEFsbCBvdGhlciBmaWxlIHR5cGVzIGFyZSBsZWZ0IGFsb25lLlxuICAgICAgLy8gbm90ZTogcmVhZEZpbGUgd2lsbCBieSBkZWZhdWx0IHJldHVybiBhIFVpbnQ4QXJyYXkgYmluYXJ5IG5vZGUgYnVmZmVyXG4gICAgICBkYXRhID0gYXdhaXQgRmlsZU1hbmFnZXIucmVhZEZpbGUocmVzb2x2ZWRMb2NhdGlvbik7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGRpZ2VzdFZhbHVlID0gYXdhaXQgZGlnZXN0LkRpZ2VzdChkYXRhKTtcblxuICAgICAgLy8gdGhlIGZpbGVIYXNoIHNob3VsZCBiZSByZXByZXNlbnRlZCBhcyBhIGJhc2U2NCBzdHJpbmdcbiAgICAgIGNvbnN0IGJhc2U2NERpZ2VzdCA9IEJ1ZmZlci5mcm9tKGRpZ2VzdFZhbHVlKS50b1N0cmluZyhcImJhc2U2NFwiKTtcbiAgICAgIHJldHVybiBiYXNlNjREaWdlc3Q7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zb2xlLmVycm9yKFwiZXJyb3IgaGFzaGluZyBmaWxlXCIsIGVycik7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG4gIC8qKlxuICAgKiBBZGQgYSBtYW5pZmVzdCByZWZlcmVuY2UgdG8gdGhlIHNpZ25hdHVyZS4gVXNpbmcgYW4gT2JqZWN0ID4gTWFuaWZlc3QgaXMgdGhlIHJlY29tbWVuZGVkIHNpZ25hdHVyZSBmb3JtXG4gICAqIGluIHRoZSBlcHViIHNwZWMuIHNlZTogaHR0cHM6Ly93d3cudzMub3JnL3B1Ymxpc2hpbmcvZXB1YjMyL2VwdWItb2NmLmh0bWwjc2VjLWNvbnRhaW5lci1tZXRhaW5mLXNpZ25hdHVyZXMueG1sXG4gICAqIEEgY29tbWVudCBpbiB0aGUgZXhhbXBsZSBub3RlcyB0aGF0IHhtbC9odG1sIGZpbGVzIHNob3VsZCBiZSBjYW5vbmljYWxpemVkIGJlZm9yZSB0aGUgZGlnZXN0IGlzIHByb2R1Y2VkIC1cbiAgICogdGhhdCBpcyB0aGUgYXBwcm9hY2ggdGFrZW4gYmVsb3cuXG4gICAqXG4gICAqIFRPRE8hIHRoaXMgZG9lcyBub3QgYXBwbHkgdGhlIHRyYW5zZm9ybXMuIEN1cnJlbnRseSBhbGwgeG1sIGZpbGVzIGFyZSBub3JtYWxpemVkIGRvd25zdHJlYW0uXG4gICAqIChzZWUgZ2VuZXJhdGVGaWxlRGlnZXN0IGFib3ZlKS4gb3IgdGhhdCB0cmFuc2Zvcm1zIGhhcHBlbmVkIHVwc3RyZWFtIGFuZCBpbmNsdWRlZCBpbiBwcm92aWRlZCBkaWdlc3RWYWx1ZVxuICAgKlxuICAgKiBOb3RlIHRoYXQgV2ViQ3J5cHRvIGRvZXMgbm90IGFjY2VwdCBzdHJlYW1zLCBzbyB0aGUgZW50aXJlIGZpbGUgbXVzdCBiZSBsb2FkZWQgaW50byBtZW1vcnkuIE5vZGUgaGFzIGEgMWdiXG4gICAqIGZpbGUgc2l6ZSBsaW1pdCAoPykgLSBzbyBsYXJnZSBmaWxlcyBjYW5ub3QgYmUgZGlnZXN0ZWQuXG4gICAqIHNlZTpcbiAgICogaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvQVBJL1N1YnRsZUNyeXB0by9kaWdlc3RcbiAgICogaHR0cHM6Ly9naXRodWIuY29tL3czYy93ZWJjcnlwdG8vaXNzdWVzL1xuICAgKiBodHRwczovL3d3dy53My5vcmcvVFIvMjAwOC9SRUMteG1sZHNpZy1jb3JlLTIwMDgwNjEwLyNzZWMtRW52ZWxvcGVkU2lnbmF0dXJlXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBsb2NhdGlvbiAtIHBhdGggdG8gdGhlIHJlc291cmNlLCByZWxhdGl2ZSB0byB0aGUgZXB1YiByb290XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkaWdlc3RNZXRob2QgLSB0aGUgZGlnZXN0IHN0YW5kYXJkIHRvIHVzZS4gc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9QZWN1bGlhclZlbnR1cmVzL3htbGRzaWdqc1xuICAgKi9cbiAgYXN5bmMgYWRkTWFuaWZlc3RSZWZlcmVuY2UoXG4gICAgbG9jYXRpb24sXG4gICAgdHJhbnNmb3JtcyA9IFtcImh0dHA6Ly93d3cudzMub3JnL1RSLzIwMDEvUkVDLXhtbC1jMTRuLTIwMDEwMzFcIl0sXG4gICAgZGlnZXN0TWV0aG9kID0gXCJodHRwOi8vd3d3LnczLm9yZy8yMDAxLzA0L3htbGVuYyNzaGEyNTZcIixcbiAgICBkaWdlc3RWYWx1ZSA9IHVuZGVmaW5lZFxuICApIHtcbiAgICBpZiAoZGlnZXN0VmFsdWUpIHtcbiAgICAgIC8vIGlmIGRpZ2VzdFZhbHVlIGlzIHByb3ZpZGVkLCB1c2UgdGhhdFxuICAgICAgdGhpcy5vYmplY3QubWFuaWZlc3QuYWRkUmVmZXJlbmNlKFxuICAgICAgICBsb2NhdGlvbixcbiAgICAgICAgdHJhbnNmb3JtcyxcbiAgICAgICAgZGlnZXN0TWV0aG9kLFxuICAgICAgICBkaWdlc3RWYWx1ZVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gaWYgbm8gZGlnZXN0VmFsdWUgaXMgcHJvdmlkZWQsIGdlbmVyYXRlIGEgbmV3IG9uZVxuICAgICAgY29uc3QgYmFzZTY0RGlnZXN0ID0gYXdhaXQgdGhpcy5nZW5lcmF0ZUZpbGVEaWdlc3QoXG4gICAgICAgIGxvY2F0aW9uLFxuICAgICAgICBkaWdlc3RNZXRob2RcbiAgICAgICk7XG5cbiAgICAgIGlmIChiYXNlNjREaWdlc3QpIHtcbiAgICAgICAgdGhpcy5vYmplY3QubWFuaWZlc3QuYWRkUmVmZXJlbmNlKFxuICAgICAgICAgIGxvY2F0aW9uLFxuICAgICAgICAgIHRyYW5zZm9ybXMsXG4gICAgICAgICAgZGlnZXN0TWV0aG9kLFxuICAgICAgICAgIGJhc2U2NERpZ2VzdFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuIl19